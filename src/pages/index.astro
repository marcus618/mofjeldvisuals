---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { CldImage } from 'astro-cloudinary';

const allImages = await getCollection('photography');

const favourites = allImages.filter(img => img.data.tags?.includes('favourite'));
const nonFavourites = allImages.filter(img => !img.data.tags?.includes('favourite'));

const sortedImages = [...favourites, ...nonFavourites];

const numColumns = 3;
const columns = Array.from({ length: numColumns }, () => []);
const columnHeights = Array(numColumns).fill(0);

sortedImages.forEach((image) => {
    const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
    columns[shortestColumnIndex].push(image);
    columnHeights[shortestColumnIndex] += image.data.height / image.data.width;
});
---

<Layout title="Mofjeld Visuals">
    <div class="container mx-auto px-4 max-w-screen-xl">
        <!-- THE MASONRY GRID CONTAINER -->
        <div 
            class="pswp-gallery flex flex-col md:flex-row gap-4" 
            id="gallery--main"
        >
            {columns.map(column => (
                <div class="flex flex-col gap-4 md:w-1/3">
                    {column.map(image => (
                        // The `break-inside-avoid` class is key to preventing images from splitting
                        <a
                            href={image.data.secure_url}
                            data-pswp-width={image.data.width}
                            data-pswp-height={image.data.height}
                            target="_blank"
                            rel="noreferrer"
                            class="group block"
                        >
                            <CldImage 
                                src={image.data.public_id}
                                width={image.data.width}
                                height={image.data.height}
                                alt="A portfolio image"
                                class="w-full h-auto object-cover rounded-md shadow-lg transform transition-transform duration-300 group-hover:scale-105"
                            />
                        </a>
                    ))}
                </div>
            ))}
        </div>

        {allImages.length === 0 && (
            <div class="text-center text-gray-500 py-20">
                <h2 class="text-2xl font-bold mb-2">No Images Found in Cloudinary</h2>
                <p>Please make sure your images are uploaded to the correct Cloudinary folder and the folder name is correctly specified in <code>src/content/config.ts</code>.</p>
            </div>
        )}
	</div>
</Layout>


<script>
    import PhotoSwipeLightbox from 'photoswipe/lightbox';

    const lightbox = new PhotoSwipeLightbox({
        // The container element for the gallery
        gallery: '#gallery--main',
        // The selector for the gallery items
        children: 'a',
        // PhotoSwipe options
        pswpModule: () => import('photoswipe'),
    });

    // Initialize the lightbox
    lightbox.init();

</script>